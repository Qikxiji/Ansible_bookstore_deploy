# Ansible PHP website deploy

>Развёртывание [шаблонного сайта на PHP + MySQL](https://github.com/Qikxiji/Php_MySQL_bookstore_deploy) с помощью Ansible.

## Решаемые задачи
Поставлена задача развернуть сайт на 2 виртуальных машинах (ВМ) под управлением ubuntu server с помощью Ansible. Веб-сервер развёртывается на первой ВМ, именованной `vm102-nginx-php-pfm`, база данных (БД) развёртывается на второй ВМ, именованной `vm103-mysql`. ВМ общаются по локальной сети (соответственно находятся в одной подсети). Перед запуском сценария (playbook) на обеих машинах должен быть настроен доступ по ssh для пользователя root. В моем случае доступ реализован по ключу, ссылка на который расположена в inventory файле, в переменной `ansible_private_key_file`.

## Структура проекта

```
$PROJECT_ROOT
│  
├── files                  # Директория с файлами, загружаемыми на хосты
│   ├── bookstore/          # Исходные файлы сайта (.php .css .jpg)
│   ├── bookstore_j2/       # Часть исходных файлов сайта, реализованнх в виде шаблонов jinja2
│   ├── db/                 # Файл конфигурации и дамп БД
│   ├── netconf/            # Файлы конфигурации сети (шаблоны jinja2)
│   ├── nginx/              # Файлы конфигурации nginx и php-fpm (в т.ч. шаблоны jinja2)
│
├── inventory/proxmox.ini   # Файл реестра (inventory файл)
│  
├── vars                   # Директория с переменными, используемыми в сценарии и шаблонах jinja2
│   ├── my_vars.yml         # Основные переменные
│   ├── secrets.yml         # Переменные-секреты (пароли от БД)
│
├── ansible.cfg             # Файл настроек ansible по умолчанию
│  
├── play_bookstore.yml      # Файл сценария

```

## Об использовани шаблонов jinja2
Файлы конфигурации и исходные файлы сайта преобразовываются в файлы-шаблоны jinja2, чтобы иметь возможность централизовано конфигурировать сервисы. К примеру, переменная  `vm103_mysql_ip` хранит статический ip адрес машины с MySQL. Эта переменная используется в:
- файлах сайта с расширением .j2;
- файлах конфигурации сети с расширением .j2;
- файлах конфигурации бд с расширением .j2;
- сценарии play_bookstore.yml.

Таким образом, изменив единственное значение переменной `vm103_mysql_ip` в файле `my_vars.yml`, и запустив сценарий на исполнение, мы автоматически обновим ip машины, а также переведём конфигурацию сайта и БД на использование нового ip адреса. Для выполнения тех же операций вручную пришлось бы редактировать 8 файлов репозитория.

## Требования для запуска
- Установить ssh и Ansible на управляющую машину, на ВМ установить openssh-server, настроить доступ с управляющей машины от лица пользователя root.

## Особенности эксплуатации в производстве

При боевом использовании сценария необходимо шифровать секреты с помощью `ansible-vault encrypt` и добавлять файл с секретами в .gitignore.

- Для запуска сценария с секретами (ручной ввод пароля)
```bash
ansible-playbook play_bookstore.yml --ask-vault-pass
```
- Для запуска сценария с секретами (загрузка пароля из файла)
```bash
ansible-playbook play_bookstore.yml --vault-password-file=password_file
```
При успешном завершении работы сценария и корректной настройке внешнего доступа, сайт станет доступен по адресу `vm102_nginx_ip` на порту 8080.

Изучить внещний вид и функционал сайта, а также развернуть его локально можно с помощью другого моего репозитория, где данный сайт [развёртывается в Docker.](https://github.com/Qikxiji/Php_MySQL_bookstore_deploy)